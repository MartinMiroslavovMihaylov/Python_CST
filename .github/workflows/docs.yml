name: Build & Deploy Sphinx Docs

on:
  push:
    branches: [ main, docu ]  # build on main or docu branch
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true  # prevents overlapping deploys

jobs:
build:
runs-on: ubuntu-latest
steps:
# Checkout main branch (code)
- name: Checkout main code
uses: actions/checkout@v5
with:
path: repo

  # Checkout docs branch (Sphinx sources)
                                               
  - name: Checkout docs branch
    uses: actions/checkout@v5
    with:
      ref: docu
      path: docs-src
      # --- Checkout docs branch ---
      - name: Checkout docs branch
        uses: actions/checkout@v5
        with:
          ref: docu
          path: docs-src

# Set up Python
  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: "3.11"
      cache: "pip"
      cache-dependency-path: "docs-src/requirements-docs.txt"

  # Install dependencies including Constructor requirements
  - name: Install doc dependencies
    run: |
      python -m pip install --upgrade pip
                                
                    
      pip install -r docs-src/requirements-docs.txt
      pip install matplotlib pandas  # add other dependencies your code needs
      echo "CODE_DIR=${GITHUB_WORKSPACE}/repo" >> $GITHUB_ENV
  # Sanity import check
  - name: Sanity import check
    run: |
      python - <<'PY'
      import os, sys
      code_dir = os.environ["CODE_DIR"]
      sys.path.insert(0, code_dir)
      from CST_Constructor.CST_Constructor import CST_Commands, Curves
      print("Imported CST_Constructor successfully:", CST_Commands, Curves)
      PY

  # Build Sphinx HTML
  - name: Build Sphinx HTML
    env:
      CODE_DIR: ${{ github.workspace }}/repo
    run: sphinx-build -b html docs-src _site

  # Upload Pages artifact
  - name: Upload Pages artifact
    uses: actions/upload-pages-artifact@v3
    with:
                                               
      path: _site
                                               
                                                                
              
                                                       
                          